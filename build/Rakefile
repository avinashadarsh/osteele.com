RSYNC_HOSTNAME = 'osteele.com'
RSYNC_TARGET = 'osteele.com'
RSYNC_OPTIONS = []

desc "Push to server"
task :push do
  rsync
end

desc "Push to staging server"
task :staging do
  RSYNC_TARGET.sub!(/.*/, 'staging.osteele.com')
  rsync
end

desc "Show what would be pushed"
task :dry_run do
  RSYNC_OPTIONS << '-n'
  rsync
end

def rsync
  options = ['-avz']
  options += RSYNC_OPTIONS
  options << '--delete'
  options << '--delete-after'
  options << "--exclude-from #{File.join(File.dirname(__FILE__), 'rsync.exclude')}"
  options << '--exclude wp'
  src = File.join(File.dirname(__FILE__), '..')
  sh "rsync #{options.join(' ')} #{src}/ #{RSYNC_HOSTNAME}:#{RSYNC_TARGET}"
end

desc "Create the cache directories"
task :make_cache_dirs do
  paths = %w[sources/javascript sources/php tools/reanimator tools/rework tools/svn2ics wp/wp-content].map {|path| "osteele.com/#{path}/cache"}
  cmds = paths.map { |path| "mkdir -p #{path}; chmod a+w #{path}" }
  cmd = cmds.join("; ")
  sh "ssh #{RSYNC_HOSTNAME} '#{cmd}'"
end

task :sites do
  options = %w[-avz --delete --delete-after --exclude-from] +
    [File.join(File.dirname(__FILE__), 'rsync.exclude')]
  src = File.join(File.dirname(__FILE__), '../sites')
  sh "rsync #{options.join(' ')} #{src}/ #{RSYNC_HOSTNAME}:sites"
end
